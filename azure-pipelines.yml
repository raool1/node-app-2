trigger:
- master

pool:
  name: Default  # Your self-hosted agent pool name

variables:
  artifactName: 'nodeapp-artifact'
  buildDir: '$(Build.ArtifactStagingDirectory)'

steps:
# 1ï¸âƒ£ Use Node.js 18
- task: UseNode@1
  inputs:
    version: '18.x'
  displayName: 'Use Node.js 18'

# 2ï¸âƒ£ Install Dependencies
- script: |
    npm install
  displayName: 'ğŸ“¦ Install dependencies'

# 3ï¸âƒ£ Optional Build (only runs if build script exists)
- script: |
    npm run build || echo "No build script found"
  displayName: 'ğŸ—ï¸ Build the app'

# 4ï¸âƒ£ Copy Files to Staging Directory
- task: CopyFiles@2
  inputs:
    SourceFolder: '$(Build.SourcesDirectory)'
    Contents: '**'
    TargetFolder: '$(buildDir)'
  displayName: 'ğŸ“ Copy project files to staging dir'

# 5ï¸âƒ£ Publish Artifacts (optional if using release pipeline)
- task: PublishBuildArtifacts@1
  inputs:
    PathtoPublish: '$(Build.ArtifactStagingDirectory)'
    ArtifactName: '$(artifactName)'
    publishLocation: 'Container'
  displayName: 'ğŸ“¦ Publish Artifact'

# 6ï¸âƒ£ Deploy using PM2
- script: |
    echo "ğŸ“¦ Installing PM2..."
    sudo npm install -g pm2

    echo "ğŸš€ Copying files to deployment directory..."
    rm -rf ~/node-deploy && mkdir ~/node-deploy
    cp -r $(buildDir)/* ~/node-deploy

    echo "ğŸ“‚ Listing deployed files:"
    ls -la ~/node-deploy

    echo "ğŸ” Checking for index.js..."
    if [ ! -f ~/node-deploy/index.js ]; then
      echo "âŒ index.js not found in ~/node-deploy"
      exit 1
    fi

    cd ~/node-deploy
    npm install

    echo "ğŸš€ Starting app with PM2..."
    pm2 delete my-node-app || true
    pm2 start index.js --name my-node-app --watch
    pm2 save
  displayName: 'ğŸš€ Deploy & Start Node App with PM2'
