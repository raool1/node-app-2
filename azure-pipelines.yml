trigger:
- master

pool:
  name: Default  # Use your self-hosted agent pool name

variables:
  deployDir: '/home/azureuser/node-deploy'

steps:
# 1️⃣ Use Node.js
- task: UseNode@1
  inputs:
    version: '18.x'
  displayName: '🔧 Use Node.js 18'

# 2️⃣ Install Dependencies
- script: |
    npm install
  displayName: '📦 Install dependencies'

# 3️⃣ (Optional) Build
- script: |
    npm run build || echo "No build script found"
  displayName: '🏗️ Build (optional)'

# 4️⃣ Deploy to Server Folder & Start with PM2
- script: |
    echo "🚀 Installing PM2 globally..."
    sudo npm install -g pm2

    echo "📁 Cleaning previous deploy dir and copying new files..."
    rm -rf $(deployDir) && mkdir -p $(deployDir)
    cp -r $(Build.SourcesDirectory)/* $(deployDir)

    echo "📂 Contents of deployment directory:"
    ls -la $(deployDir)

    echo "📦 Installing dependencies on server..."
    cd $(deployDir)
    npm install

    echo "🚀 Starting app with PM2..."
    pm2 delete my-node-app || true
    pm2 start index.js --name my-node-app
    pm2 save
  displayName: '🚀 Deploy & Start with PM2'
