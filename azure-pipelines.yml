trigger:
- master  # or main, based on your repo

pool:
  name: Default  # Your self-hosted agent pool

variables:
  appName: 'my-node-app'

steps:
# 1️⃣ Use Node.js 18
- task: UseNode@1
  inputs:
    version: '18.x'
  displayName: 'Use Node.js 18'

# 2️⃣ Install dependencies
- script: |
    cd $(Build.SourcesDirectory)
    npm install
  displayName: '📦 Install dependencies'

# 3️⃣ (Optional) Build (skip if not needed)
- script: |
    cd $(Build.SourcesDirectory)
    npm run build || echo "No build step"
  displayName: '🏗️ Build the app (optional)'

# 4️⃣ Start app with PM2 from working directory
- script: |
    echo "🚀 Starting app with PM2..."

    sudo npm install -g pm2

    cd $(Build.SourcesDirectory)

    pm2 delete $(appName) || true
    pm2 start index.js --name $(appName) --watch
    pm2 save
  displayName: '🚀 Deploy & Start Node App with PM2'
