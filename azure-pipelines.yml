trigger:
- master  # Change to 'main' if that's your default branch

pool:
  name: Default  # Make sure this matches your self-hosted agent pool name

variables:
  appName: 'my-node-app'
  deployPath: '/home/azureuser/node-app'

steps:
# 1ï¸âƒ£ Use Node.js 18
- task: UseNode@1
  inputs:
    version: '18.x'
  displayName: 'Use Node.js 18'

# 2ï¸âƒ£ Install dependencies in the pipeline source directory
- script: |
    cd $(Build.SourcesDirectory)
    npm install
  displayName: 'ğŸ“¦ Install dependencies'

# 3ï¸âƒ£ Optional build step
- script: |
    cd $(Build.SourcesDirectory)
    npm run build || echo "âš ï¸ No build step found"
  displayName: 'ğŸ—ï¸ Build the app (optional)'

# 4ï¸âƒ£ Sync code to fixed folder and run with PM2
- script: |
    echo "ğŸ” Syncing code to $(deployPath)..."
    sudo rm -rf $(deployPath)
    sudo mkdir -p $(deployPath)
    sudo cp -r $(Build.SourcesDirectory)/* $(deployPath)

    echo "ğŸš€ Installing PM2 and starting the app..."
    cd $(deployPath)

    npm install
    sudo npm install -g pm2

    pm2 delete $(appName) || true
    pm2 start index.js --name $(appName) --watch
    pm2 save
  displayName: 'ğŸš€ Deploy & Start Node App with PM2'
