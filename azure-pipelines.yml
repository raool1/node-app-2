trigger:
- master

pool:
  name: Default  # Self-hosted agent name

variables:
  artifactName: 'nodeapp-artifact'
  buildDir: '$(Build.ArtifactStagingDirectory)/node-app-2'

steps:
# 1ï¸âƒ£ Use Node.js
- task: UseNode@1
  inputs:
    version: '18.x'
  displayName: 'Use Node.js 18'

# 2ï¸âƒ£ Install dependencies
- script: |
    npm install
  displayName: 'ğŸ“¦ Install dependencies'

# 3ï¸âƒ£ Optional build step
- script: |
    npm run build || echo "No build step"
  displayName: 'ğŸ—ï¸ Build app'

# 4ï¸âƒ£ Copy files to staging
- task: CopyFiles@2
  inputs:
    SourceFolder: '$(Build.SourcesDirectory)'
    Contents: '**'
    TargetFolder: '$(buildDir)'
  displayName: 'ğŸ“ Copy to staging dir'

# 5ï¸âƒ£ Publish build artifact
- task: PublishBuildArtifacts@1
  inputs:
    PathtoPublish: '$(Build.ArtifactStagingDirectory)'
    ArtifactName: '$(artifactName)'
    publishLocation: 'Container'
  displayName: 'ğŸ“¦ Publish artifact'

# -----------------------------
# â¬‡ï¸ DEPLOYMENT SECTION (on self-hosted agent)
# -----------------------------

# 6ï¸âƒ£ Download the artifact
- task: DownloadBuildArtifacts@0
  inputs:
    buildType: 'current'
    downloadType: 'single'
    artifactName: '$(artifactName)'
    downloadPath: '$(System.DefaultWorkingDirectory)/downloaded'

# 7ï¸âƒ£ Deploy with PM2
- script: |
    echo "âœ… Installing PM2..."
    sudo npm install -g pm2

    echo "ğŸ“‚ Copying to ~/node-deploy..."
    rm -rf ~/node-deploy && mkdir ~/node-deploy
    cp -r $(System.DefaultWorkingDirectory)/downloaded/$(artifactName)/node-app-2/* ~/node-deploy

    echo "ğŸ“ Contents of ~/node-deploy:"
    ls -la ~/node-deploy

    cd ~/node-deploy
    npm install

    pm2 delete node-app-2 || true
    pm2 start index.js --name node-app-2
    pm2 save
  displayName: 'ğŸš€ Deploy node-app-2 with PM2'
