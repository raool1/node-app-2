trigger:
- master  # âœ… Make sure this matches your actual branch name

pool:
  name: Default  # âœ… This should match the name of your self-hosted agent pool

variables:
  artifactName: 'nodeapp-artifact'
  buildDir: '$(Build.ArtifactStagingDirectory)/app'

steps:

# âœ… Use Node.js 18
- task: UseNode@1
  inputs:
    version: '18.x'
  displayName: 'Use Node.js 18'

# âœ… Install dependencies
- script: |
    npm install
  displayName: 'ğŸ“¦ Install dependencies'

# âœ… Build the app (if you have a build step)
- script: |
    npm run build
  displayName: 'ğŸ—ï¸ Build the app'

# âœ… Copy files to staging directory
- task: CopyFiles@2
  inputs:
    SourceFolder: '$(Build.SourcesDirectory)'
    Contents: '**'
    TargetFolder: '$(buildDir)'
  displayName: 'ğŸ“ Copy files to staging'

# âœ… Publish artifacts
- task: PublishBuildArtifacts@1
  inputs:
    PathtoPublish: '$(Build.ArtifactStagingDirectory)'
    ArtifactName: '$(artifactName)'
    publishLocation: 'Container'
  displayName: 'ğŸ“¦ Publish artifact'

# âœ… Deploy using PM2
- script: |
    sudo npm install -g pm2

    rm -rf ~/node-deploy && mkdir ~/node-deploy
    cp -r $(buildDir)/* ~/node-deploy

    cd ~/node-deploy
    npm install

    pm2 delete my-node-app || true
    pm2 start index.js --name my-node-app
    pm2 save
  displayName: 'ğŸš€ Deploy using PM2'
