trigger:
- master

pool:
  name: Default  # Use your self-hosted agent pool name

variables:
  deployDir: '/home/azureuser/node-deploy'

steps:
# 1ï¸âƒ£ Use Node.js
- task: UseNode@1
  inputs:
    version: '18.x'
  displayName: 'ğŸ”§ Use Node.js 18'

# 2ï¸âƒ£ Install Dependencies
- script: |
    npm install
  displayName: 'ğŸ“¦ Install dependencies'

# 3ï¸âƒ£ (Optional) Build
- script: |
    npm run build || echo "No build script found"
  displayName: 'ğŸ—ï¸ Build (optional)'

# 4ï¸âƒ£ Deploy to Server Folder & Start with PM2
- script: |
    echo "ğŸš€ Installing PM2 globally..."
    sudo npm install -g pm2

    echo "ğŸ“ Cleaning previous deploy dir and copying new files..."
    rm -rf $(deployDir) && mkdir -p $(deployDir)
    cp -r $(Build.SourcesDirectory)/* $(deployDir)

    echo "ğŸ“‚ Contents of deployment directory:"
    ls -la $(deployDir)

    echo "ğŸ“¦ Installing dependencies on server..."
    cd $(deployDir)
    npm install

    echo "ğŸš€ Starting app with PM2..."
    pm2 delete my-node-app || true
    pm2 start index.js --name my-node-app
    pm2 save
  displayName: 'ğŸš€ Deploy & Start with PM2'
